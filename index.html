<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Show AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Quản lý Show AI</h1>

        <!-- Form Thêm Show -->
        <div class="bg-white p-4 rounded shadow mb-4">
            <h2 class="text-xl font-semibold mb-2">Thêm Show Mới</h2>
            <form id="addForm" class="space-y-2">
                <input type="text" id="name" placeholder="Tên" class="w-full p-2 border rounded" required>
                <textarea id="description" placeholder="Mô tả (mỗi mô tả một dòng)"
                    class="w-full p-2 border rounded h-40" required></textarea>
                <input type="text" id="tags" placeholder="Tags (phân cách bằng dấu phẩy)"
                    class="w-full p-2 border rounded">
                <textarea id="keyfeature" placeholder="Key Features (mỗi feature một dòng)"
                    class="w-full p-2 border rounded h-40"></textarea>
                <input type="url" id="link" placeholder="Đường dẫn" class="w-full p-2 border rounded" required>
                <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Thêm Show</button>
            </form>
        </div>

        <!-- Danh sách Show -->
        <div id="showList" class="space-y-4"></div>

        <!-- Modal Chỉnh sửa Show -->
        <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
            <div class="bg-white p-4 rounded shadow-lg w-1/2">
                <h2 class="text-xl font-semibold mb-2">Chỉnh sửa Show</h2>
                <form id="editForm" class="space-y-2">
                    <input type="hidden" id="editId">
                    <input type="text" id="editName" placeholder="Tên" class="w-full p-2 border rounded" required>
                    <textarea id="editDescription" placeholder="Mô tả (mỗi mô tả một dòng)"
                        class="w-full p-2 border rounded h-40" required></textarea>
                    <input type="text" id="editTags" placeholder="Tags (phân cách bằng dấu phẩy)"
                        class="w-full p-2 border rounded">
                    <textarea id="editKeyfeature" placeholder="Key Features (mỗi feature một dòng)"
                        class="w-full p-2 border rounded h-40"></textarea>
                    <input type="url" id="editLink" placeholder="Đường dẫn" class="w-full p-2 border rounded" required>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="hideEditModal()"
                            class="bg-gray-300 text-black p-2 rounded hover:bg-gray-400">Hủy</button>
                        <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Lưu thay
                            đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api/showai';

        let allShows = []; // Biến toàn cục để lưu trữ tất cả show

        // Lấy và hiển thị danh sách show
        async function fetchShows() {
            try {
                const response = await axios.get(API_URL);
                allShows = response.data; // Lưu tất cả show vào biến toàn cục
                displayShows(allShows);
            } catch (error) {
                console.error('Lỗi khi lấy danh sách show:', error);
                alert('Có lỗi xảy ra khi tải danh sách show. Vui lòng thử lại sau.');
            }
        }

        function displayShows(shows) {
            const showList = document.getElementById('showList');
            showList.innerHTML = '';
            shows.forEach(show => {
                const showElement = createShowElement(show);
                showList.appendChild(showElement);
            });
        }

        // Tạo phần tử show
        function createShowElement(show) {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded shadow mb-4';
            div.innerHTML = `
                <h3 class="text-xl font-semibold">${show.name}</h3>
                <div class="mt-2">
                    <strong>Mô tả:</strong>
                    <p class="whitespace-pre-line">
                        ${Array.isArray(show.description) && show.description.length > 0
                    ? show.description.join('\n\n')
                    : 'Không có mô tả'}
                    </p>
                </div>
                <p class="mt-2"><strong>Tags:</strong> ${Array.isArray(show.tags) ? show.tags.join(', ') : 'Không có tags'}</p>
                <div class="mt-2">
                    <strong>Key Features:</strong>
                    <ul class="list-disc list-inside">
                        ${Array.isArray(show.keyFeatures) && show.keyFeatures.length > 0
                    ? show.keyFeatures.map(feature => `<li>${feature}</li>`).join('')
                    : '<li>Không có key features</li>'}
                    </ul>
                </div>
                <a href="${show.link}" target="_blank" class="text-blue-500 mt-2 inline-block">Truy cập</a>
                <div class="mt-2">
                    <button onclick="editShow(${show.id})" class="bg-yellow-500 text-white p-1 rounded hover:bg-yellow-600">Sửa</button>
                    <button onclick="deleteShow(${show.id})" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">Xóa</button>
                </div>
            `;
            return div;
        }

        // Thêm show mới
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newShow = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value.split('\n').map(desc => desc.trim()).filter(Boolean),
                tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()),
                keyFeatures: document.getElementById('keyfeature').value.split('\n').map(feature => feature.trim()).filter(Boolean),
                link: document.getElementById('link').value
            };
            try {
                await axios.post(API_URL, newShow);
                fetchShows();
                e.target.reset();
            } catch (error) {
                console.error('Lỗi khi thêm show:', error);
            }
        });

        // Sửa show
        function editShow(id) {
            console.log('Đang mở modal chỉnh sửa cho show ID:', id);
            const show = allShows.find(s => s.id === id);

            if (!show) {
                console.error('Không tìm thấy show với ID:', id);
                alert('Không tìm thấy thông tin show. Vui lòng thử lại.');
                return;
            }

            document.getElementById('editId').value = show.id;
            document.getElementById('editName').value = show.name || '';
            document.getElementById('editDescription').value = Array.isArray(show.description) ? show.description.join('\n') : '';
            document.getElementById('editTags').value = Array.isArray(show.tags) ? show.tags.join(', ') : '';
            document.getElementById('editKeyfeature').value = Array.isArray(show.keyFeatures) ? show.keyFeatures.join('\n') : '';
            document.getElementById('editLink').value = show.link || '';

            showEditModal();
            console.log('Modal đã được hiển thị');
        }

        // Hiển thị modal chỉnh sửa
        function showEditModal() {
            console.log('Đang hiển thị modal');
            const modal = document.getElementById('editModal');
            console.log('Trạng thái modal trước khi hiển thị:', modal.classList.contains('hidden'));
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            console.log('Trạng thái modal sau khi hiển thị:', modal.classList.contains('hidden'));
        }

        // Ẩn modal chỉnh sửa
        function hideEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // Xử lý sự kiện submit form chỉnh sửa
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('editId').value);
            const updatedShow = {
                id: id,
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value.split('\n').map(desc => desc.trim()).filter(Boolean),
                tags: document.getElementById('editTags').value.split(',').map(tag => tag.trim()).filter(Boolean),
                keyFeatures: document.getElementById('editKeyfeature').value.split('\n').map(feature => feature.trim()).filter(Boolean),
                link: document.getElementById('editLink').value
            };

            const index = allShows.findIndex(s => s.id === id);
            if (index !== -1) {
                allShows[index] = updatedShow;
                try {
                    await axios.put(`${API_URL}/${id}`, updatedShow);
                    displayShows(allShows);
                    hideEditModal();
                } catch (error) {
                    console.error('Lỗi khi cập nhật show:', error);
                    alert('Có lỗi xảy ra khi cập nhật show. Vui lòng thử lại.');
                }
            } else {
                alert('Không tìm thấy show để cập nhật.');
            }
        });

        // Xóa show
        async function deleteShow(id) {
            if (confirm('Bạn có chắc chắn muốn xóa show này?')) {
                try {
                    await axios.delete(`${API_URL}/${id}`);
                    fetchShows();
                } catch (error) {
                    console.error('Lỗi khi xóa show:', error);
                }
            }
        }

        // Lấy danh sách show ban đầu
        fetchShows();
    </script>
</body>

</html>